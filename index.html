<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SFL Collection Tracker</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='10' fill='%23614126'/%3E%3Cg fill='%23FFD700'%3E%3Cellipse cx='32' cy='14' rx='7' ry='12'/%3E%3Cellipse cx='32' cy='50' rx='7' ry='12'/%3E%3Cellipse cx='14' cy='32' rx='12' ry='7'/%3E%3Cellipse cx='50' cy='32' rx='12' ry='7'/%3E%3Cellipse cx='19' cy='19' rx='7' ry='12' transform='rotate(-45 19 19)'/%3E%3Cellipse cx='45' cy='45' rx='7' ry='12' transform='rotate(-45 45 45)'/%3E%3Cellipse cx='45' cy='19' rx='7' ry='12' transform='rotate(45 45 19)'/%3E%3Cellipse cx='19' cy='45' rx='7' ry='12' transform='rotate(45 19 45)'/%3E%3C/g%3E%3Ccircle cx='32' cy='32' r='8' fill='%23614126'/%3E%3C/svg%3E">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-darkest: #0d0906;
      --bg-dark: #1a0e08;
      --bg-medium: #2c1810;
      --bg-light: #3e2415;
      --bg-card: #2a1a0f;
      --bg-card-alt: #231509;
      --border-dark: #000;
      --border-brown: #5c3a1e;
      --border-light: #8b6914;
      --text-primary: #f0e6d2;
      --text-secondary: #c4a882;
      --text-dim: #9a8060;
      --green: #30D158;
      --red: #FF6B6B;
      --yellow: #FFD60A;
      --blue: #5DADE2;
      --sunpetal: #FFD700;
      --bloom: #FF69B4;
      --lily: #B07CD8;
      --edelweiss: #87CEEB;
      --gladiolus: #FF6347;
      --lavender: #C8A2C8;
      --clover: #2ECC71;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg-darkest);
      color: var(--text-primary);
      font-family: 'Courier New', monospace;
      min-height: 100vh;
      image-rendering: pixelated;
    }

    .pixel-font { font-family: 'Press Start 2P', cursive; }

    .pixel-panel {
      background: var(--bg-medium);
      border: 4px solid var(--border-brown);
      box-shadow:
        inset 3px 3px 0 rgba(255,255,255,0.08),
        inset -3px -3px 0 rgba(0,0,0,0.25),
        0 0 0 3px var(--border-dark),
        6px 6px 0 rgba(0,0,0,0.4);
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 12px;
    }

    /* â”€â”€ Nav Bar â”€â”€ */
    .nav-bar {
      display: flex;
      align-items: stretch;
      margin-bottom: 12px;
      background: var(--bg-dark);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .nav-link {
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      color: var(--text-secondary);
      background: none;
      border: none;
      padding: 14px 16px;
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: color 0.15s, border-color 0.15s;
      min-height: 44px;
      display: flex;
      align-items: center;
    }
    .nav-link:hover { color: var(--text-primary); }
    .nav-link.active {
      color: var(--sunpetal);
      border-bottom-color: var(--sunpetal);
    }
    .nav-link.help-btn {
      margin-left: auto;
      font-size: 14px;
      padding: 14px 18px;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      text-align: center;
      padding: 20px 16px;
      margin-bottom: 16px;
      background: linear-gradient(180deg, #3e2415 0%, #2c1810 100%);
      position: relative;
      overflow: hidden;
    }
    .header::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 4px;
      background: repeating-linear-gradient(90deg, var(--sunpetal) 0 8px, transparent 8px 16px);
    }
    .header h1 {
      font-size: 16px;
      letter-spacing: 1px;
      color: var(--sunpetal);
      text-shadow: 2px 2px 0 #000, 0 0 8px rgba(255,215,0,0.3);
      margin-bottom: 8px;
    }
    .header .farm-id {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* â”€â”€ Summary bar â”€â”€ */
    .summary-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      padding: 14px 16px;
      margin-bottom: 16px;
      background: var(--bg-dark);
    }
    .summary-stat {
      text-align: center;
      min-width: 100px;
    }
    .summary-stat .label {
      font-size: 10px;
      color: var(--text-dim);
      margin-bottom: 4px;
      letter-spacing: 0.5px;
    }
    .summary-stat .value {
      font-size: 16px;
      font-weight: bold;
    }
    .summary-stat .value.complete { color: var(--green); }
    .summary-stat .value.pending { color: var(--yellow); }
    .summary-stat .value.time { color: var(--blue); }

    /* â”€â”€ Progress overview â”€â”€ */
    .progress-overview {
      padding: 12px 16px;
      margin-bottom: 16px;
    }
    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }
    .progress-bar-outer {
      background: #111;
      border: 3px solid #000;
      height: 20px;
      position: relative;
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.6);
    }
    .progress-bar-fill {
      height: 100%;
      transition: width 0.8s ease-out;
      position: relative;
    }
    .progress-bar-fill.green {
      background: linear-gradient(180deg, #4ade80 0%, #22c55e 40%, #16a34a 100%);
      box-shadow: inset 0 2px 0 rgba(255,255,255,0.25), inset 0 -2px 0 rgba(0,0,0,0.2);
    }
    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        90deg,
        transparent 0 6px,
        rgba(0,0,0,0.12) 6px 8px
      );
    }

    /* â”€â”€ Seed section â”€â”€ */
    .seed-section {
      margin-bottom: 20px;
    }
    .seed-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: var(--bg-dark);
      border: 3px solid var(--border-dark);
      border-bottom: none;
      box-shadow: inset 3px 3px 0 rgba(255,255,255,0.05);
    }
    .seed-icon {
      width: 28px;
      height: 28px;
      image-rendering: pixelated;
      filter: drop-shadow(1px 1px 0 #000);
    }
    .seed-header h2 {
      font-size: 13px;
      flex: 1;
    }
    .seed-meta {
      font-size: 10px;
      color: var(--text-dim);
      text-align: right;
    }
    .seed-meta span { display: block; margin-top: 2px; }
    .seed-badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 9px;
      border: 2px solid;
      margin-left: 4px;
    }

    /* â”€â”€ Flower grid â”€â”€ */
    .flower-grid {
      border: 3px solid var(--border-dark);
    }

    /* â”€â”€ Flower row â”€â”€ */
    .flower-row {
      display: grid;
      grid-template-columns: 36px 1fr 100px 140px;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 2px solid rgba(0,0,0,0.4);
      transition: background 0.15s;
      min-height: 48px;
      cursor: pointer;
    }
    .flower-row:nth-child(even) { background: var(--bg-card); }
    .flower-row:nth-child(odd) { background: var(--bg-card-alt); }
    .flower-row:hover { background: #382210; }
    .flower-row.complete { opacity: 0.55; }
    .flower-row.complete:hover { opacity: 0.85; }

    .flower-img-wrap {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .flower-img {
      width: 28px;
      height: 28px;
      image-rendering: pixelated;
      filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.6));
    }
    .flower-color-dot {
      width: 14px;
      height: 14px;
      border: 2px solid #000;
      box-shadow: inset 2px 2px 0 rgba(255,255,255,0.3);
    }

    .flower-info { min-width: 0; }
    .flower-name {
      font-size: 13px;
      font-weight: bold;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .flower-chain {
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .flower-chain .input-flower { color: var(--yellow); }
    .flower-chain .consumed-by { color: #c87d38; }

    .flower-progress { min-width: 0; }
    .flower-bar-outer {
      background: #111;
      border: 2px solid #000;
      height: 12px;
      box-shadow: inset 1px 1px 0 rgba(0,0,0,0.5);
      margin-bottom: 3px;
    }
    .flower-bar-fill {
      height: 100%;
      transition: width 0.6s;
    }
    .flower-bar-fill.bar-green {
      background: linear-gradient(180deg, #4ade80, #16a34a);
    }
    .flower-bar-fill.bar-yellow {
      background: linear-gradient(180deg, #fbbf24, #d97706);
    }
    .flower-bar-fill.bar-red {
      background: linear-gradient(180deg, #f87171, #dc2626);
    }
    .flower-count {
      font-size: 11px;
      display: flex;
      justify-content: space-between;
    }
    .flower-count .have { color: var(--text-secondary); }
    .flower-count .pending { color: var(--green); font-size: 10px; }

    .flower-time {
      text-align: right;
      font-size: 11px;
      color: var(--text-dim);
    }
    .flower-time .remaining-count { color: var(--yellow); font-size: 12px; }
    .flower-time .remaining-time { color: var(--text-dim); margin-top: 2px; }
    .flower-time .done { color: var(--green); font-size: 12px; }

    /* â”€â”€ Loading â”€â”€ */
    .loading-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      gap: 20px;
    }
    .loading-flower {
      font-size: 48px;
      animation: bounce 1s ease-in-out infinite;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-12px); }
    }
    .loading-text {
      font-size: 12px;
      color: var(--text-secondary);
      animation: blink 1.2s step-end infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    /* â”€â”€ Error â”€â”€ */
    .error-screen {
      text-align: center;
      padding: 40px 20px;
    }
    .error-screen .icon { font-size: 40px; margin-bottom: 12px; }
    .error-screen h2 { font-size: 14px; color: var(--red); margin-bottom: 8px; }
    .error-screen p { font-size: 11px; color: var(--text-secondary); max-width: 400px; margin: 0 auto 16px; }

    /* â”€â”€ Footer â”€â”€ */
    .footer {
      text-align: center;
      padding: 16px;
      margin-top: 8px;
    }
    .refresh-btn {
      font-family: 'Press Start 2P', cursive;
      font-size: 11px;
      color: var(--text-primary);
      background: var(--bg-light);
      border: 3px solid var(--border-brown);
      padding: 8px 18px;
      cursor: pointer;
      box-shadow:
        inset 2px 2px 0 rgba(255,255,255,0.1),
        inset -2px -2px 0 rgba(0,0,0,0.3),
        3px 3px 0 #000;
      transition: transform 0.1s;
    }
    .refresh-btn:hover { background: #4a2e18; }
    .refresh-btn:active {
      transform: translate(2px, 2px);
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.3), inset -2px -2px 0 rgba(255,255,255,0.1);
    }
    .timestamp {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 10px;
    }

    /* â”€â”€ Tooltip for consumed-by â”€â”€ */
    .consumed-tag {
      display: inline-block;
      font-size: 9px;
      padding: 1px 4px;
      margin-left: 3px;
      border: 1px solid #5c3a1e;
      background: rgba(92,58,30,0.3);
      color: #c87d38;
      vertical-align: middle;
    }

    /* â”€â”€ Config bar â”€â”€ */
    .config-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-end;
      padding: 14px 16px;
      margin-bottom: 16px;
      background: var(--bg-dark);
    }
    .config-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
      min-width: 120px;
    }
    .config-field.small { flex: 0 0 100px; min-width: 80px; }
    .config-field label {
      font-size: 9px;
      color: var(--text-dim);
      letter-spacing: 0.5px;
    }
    .config-field input {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      padding: 6px 10px;
      color: var(--text-primary);
      background: #111;
      border: 3px solid var(--border-brown);
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.5);
      outline: none;
      width: 100%;
    }
    .config-field input:focus {
      border-color: var(--sunpetal);
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.5), 0 0 6px rgba(255,215,0,0.2);
    }
    .config-field input::placeholder { color: var(--text-dim); }
    .config-go {
      font-family: 'Press Start 2P', cursive;
      font-size: 11px;
      color: #fff;
      background: #2d6a30;
      border: 3px solid #1a4a1c;
      padding: 8px 16px;
      cursor: pointer;
      box-shadow: inset 2px 2px 0 rgba(255,255,255,0.15), inset -2px -2px 0 rgba(0,0,0,0.3), 3px 3px 0 #000;
      white-space: nowrap;
      transition: transform 0.1s;
    }
    .config-go:hover { background: #38833c; }
    .config-go:active {
      transform: translate(2px, 2px);
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.3);
    }

    /* â”€â”€ Config collapsed â”€â”€ */
    .config-collapsed {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 10px 16px;
      margin-bottom: 16px;
      background: var(--bg-dark);
      cursor: pointer;
      font-size: 10px;
      color: var(--text-secondary);
    }
    .config-collapsed:hover { background: var(--bg-medium); }
    .config-toggle {
      color: var(--sunpetal);
      font-size: 9px;
    }

    /* â”€â”€ Donate section â”€â”€ */
    .donate-section {
      margin-top: 20px;
      padding: 20px 16px;
      text-align: center;
      background: linear-gradient(180deg, #2c1810 0%, #1a0e08 100%);
    }
    .donate-section h3 {
      font-size: 12px;
      color: var(--sunpetal);
      margin-bottom: 12px;
      text-shadow: 1px 1px 0 #000;
    }
    .donate-section p {
      font-size: 11px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      line-height: 1.6;
    }
    .donate-qr {
      display: inline-block;
      padding: 8px;
      background: #fff;
      border: 4px solid var(--border-brown);
      box-shadow: 0 0 0 3px #000, 4px 4px 0 rgba(0,0,0,0.4);
      margin-bottom: 12px;
    }
    .donate-qr img {
      display: block;
      width: 140px;
      height: 140px;
      image-rendering: pixelated;
    }
    .donate-addr-wrap {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #111;
      border: 3px solid var(--border-brown);
      padding: 6px 10px;
      max-width: 100%;
      box-shadow: inset 2px 2px 0 rgba(0,0,0,0.5);
    }
    .donate-addr {
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: var(--text-primary);
      word-break: break-all;
      user-select: all;
    }
    .donate-copy {
      font-family: 'Press Start 2P', cursive;
      font-size: 9px;
      color: var(--text-primary);
      background: var(--bg-light);
      border: 2px solid var(--border-brown);
      padding: 4px 8px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .donate-copy:hover { background: #4a2e18; }
    .donate-chain-label {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 8px;
    }

    /* â”€â”€ Currently Growing section â”€â”€ */
    .growing-section {
      margin-bottom: 16px;
      padding: 14px 16px;
      background: var(--bg-dark);
    }
    .growing-title {
      font-size: 11px;
      color: var(--sunpetal);
      text-align: center;
      margin-bottom: 10px;
      text-shadow: 1px 1px 0 #000;
    }
    .growing-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .growing-bed {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(255,215,0,0.06);
      border: 2px solid rgba(92,58,30,0.5);
    }
    .growing-bed.empty-bed {
      opacity: 0.35;
      background: rgba(0,0,0,0.2);
    }
    .growing-bed-img {
      width: 28px;
      height: 28px;
      image-rendering: pixelated;
      filter: drop-shadow(1px 1px 0 #000);
      flex-shrink: 0;
    }
    .growing-bed-info { flex: 1; min-width: 0; }
    .growing-bed-name {
      font-size: 11px;
      font-weight: bold;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .growing-bed-detail {
      font-size: 9px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .growing-bed-time {
      font-family: 'Press Start 2P', cursive;
      font-size: 9px;
      text-align: right;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .growing-bed-time.ready { color: var(--green); }
    .growing-bed-time.growing { color: var(--yellow); }

    /* â”€â”€ Chain detail (clickable rows) â”€â”€ */
    .chain-detail {
      padding: 10px 12px 10px 52px;
      background: rgba(0,0,0,0.3);
      border-bottom: 2px solid rgba(0,0,0,0.4);
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    .chain-detail .chain-step {
      padding-left: 14px;
      border-left: 2px solid rgba(92,58,30,0.5);
      margin-top: 4px;
    }
    .chain-detail .chain-flower { color: var(--yellow); }
    .chain-detail .chain-crop { color: var(--text-secondary); }
    .chain-detail .chain-seed { color: var(--blue); }
    .chain-detail .chain-have { color: var(--green); }
    .chain-detail .chain-need { color: var(--red); }

    /* â”€â”€ Petal Blessed panel â”€â”€ */
    .petal-blessed-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-family: 'Press Start 2P', cursive;
      font-size: 11px;
      color: #fff;
      background: linear-gradient(180deg, #6b21a8 0%, #4c1d95 50%, #3b0764 100%);
      border: 4px solid #7c3aed;
      cursor: pointer;
      box-shadow:
        inset 3px 3px 0 rgba(255,255,255,0.15),
        inset -3px -3px 0 rgba(0,0,0,0.3),
        0 0 0 3px #000,
        0 0 16px rgba(124,58,237,0.3);
      transition: transform 0.1s;
      text-shadow: 1px 1px 0 #000;
    }
    .petal-blessed-btn:hover {
      background: linear-gradient(180deg, #7c3aed 0%, #5b21b6 50%, #4c1d95 100%);
      box-shadow:
        inset 3px 3px 0 rgba(255,255,255,0.2),
        inset -3px -3px 0 rgba(0,0,0,0.3),
        0 0 0 3px #000,
        0 0 24px rgba(124,58,237,0.5);
    }
    .petal-blessed-btn:active {
      transform: translate(2px, 2px);
    }
    .pb-cooldown #pb-timer {
      color: #c084fc;
      font-size: 12px;
    }
    .petal-blessed-panel {
      margin-bottom: 16px;
      padding: 16px;
      background: linear-gradient(180deg, #2e1065 0%, #1e0a3c 100%);
      border: 4px solid #7c3aed;
      box-shadow: 0 0 0 3px #000, 0 0 20px rgba(124,58,237,0.25);
    }
    .petal-blessed-panel h3 {
      font-size: 12px;
      color: #c084fc;
      text-align: center;
      margin-bottom: 4px;
      text-shadow: 0 0 8px rgba(192,132,252,0.4);
    }
    .petal-blessed-panel .pb-subtitle {
      font-size: 10px;
      color: var(--text-dim);
      text-align: center;
      margin-bottom: 14px;
    }
    .pb-bed {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin-bottom: 6px;
      background: rgba(124,58,237,0.1);
      border: 2px solid rgba(124,58,237,0.3);
    }
    .pb-bed-num {
      font-family: 'Press Start 2P', cursive;
      font-size: 12px;
      color: #7c3aed;
      min-width: 24px;
    }
    .pb-bed-img {
      width: 28px;
      height: 28px;
      image-rendering: pixelated;
      filter: drop-shadow(1px 1px 0 #000);
    }
    .pb-bed-info { flex: 1; min-width: 0; }
    .pb-bed-name {
      font-size: 12px;
      font-weight: bold;
      color: var(--text-primary);
    }
    .pb-bed-recipe {
      font-size: 10px;
      color: var(--text-secondary);
      margin-top: 2px;
    }
    .pb-bed-time {
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      color: #c084fc;
      text-align: right;
      white-space: nowrap;
    }
    .pb-bed-time .saved { color: var(--green); }
    .pb-close {
      display: block;
      margin: 12px auto 0;
      font-family: 'Press Start 2P', cursive;
      font-size: 9px;
      color: var(--text-secondary);
      background: transparent;
      border: 2px solid rgba(124,58,237,0.3);
      padding: 6px 16px;
      cursor: pointer;
    }
    .pb-close:hover { border-color: #7c3aed; color: #c084fc; }

    /* â”€â”€ Hub cards â”€â”€ */
    .hub-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }
    .hub-card {
      padding: 24px 16px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .hub-card:hover {
      transform: translateY(-3px);
    }
    .hub-card-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }
    .hub-card h3 {
      font-size: 13px;
      color: var(--sunpetal);
      margin-bottom: 8px;
      text-shadow: 1px 1px 0 #000;
    }
    .hub-card-count {
      font-size: 10px;
      color: var(--text-secondary);
    }
    .hub-card-progress {
      font-size: 11px;
      color: var(--green);
      margin-top: 8px;
    }

    /* â”€â”€ Help Modal â”€â”€ */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal-content {
      max-width: 520px;
      width: 100%;
      padding: 24px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-content h2 {
      font-size: 14px;
      color: var(--sunpetal);
      text-align: center;
      margin-bottom: 16px;
      text-shadow: 1px 1px 0 #000;
    }
    .modal-content h3 {
      font-size: 10px;
      color: var(--sunpetal);
      margin: 14px 0 6px;
    }
    .modal-content p {
      font-size: 10px;
      color: var(--text-secondary);
      line-height: 1.8;
      margin-bottom: 8px;
    }
    .modal-content a {
      color: var(--sunpetal);
      text-decoration: none;
    }
    .modal-content a:hover { text-decoration: underline; }
    .modal-close {
      display: block;
      margin: 20px auto 0;
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      color: var(--text-primary);
      background: var(--bg-light);
      border: 3px solid var(--border-brown);
      padding: 10px 24px;
      cursor: pointer;
      box-shadow: inset 2px 2px 0 rgba(255,255,255,0.1), 3px 3px 0 #000;
    }
    .modal-close:hover { background: #4a2e18; }

    /* â”€â”€ Scanline overlay (subtle) â”€â”€ */
    body::after {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      background: repeating-linear-gradient(
        0deg,
        transparent 0 3px,
        rgba(0,0,0,0.03) 3px 4px
      );
      z-index: 9999;
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 640px) {
      .container { padding: 8px; }
      .header h1 { font-size: 13px; }
      .flower-row {
        grid-template-columns: 30px 1fr 80px;
        gap: 6px;
        padding: 6px 8px;
      }
      .flower-time { display: none; }
      .flower-row.mobile-show-time .flower-time { display: block; }
      .seed-header { flex-wrap: wrap; gap: 6px; }
      .summary-bar { gap: 8px; }
      .summary-stat { min-width: 80px; }
      .config-field { min-width: 100%; }
      .config-field.small { flex: 1; min-width: 80px; }
      .donate-addr { font-size: 10px; }
      .growing-grid { grid-template-columns: 1fr; }
      .hub-cards { grid-template-columns: 1fr; }
      .nav-link { font-size: 9px; padding: 12px 12px; }
      .nav-link.help-btn { padding: 12px 14px; font-size: 13px; }
      .config-collapsed { gap: 10px; font-size: 9px; flex-wrap: wrap; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="nav-bar"></div>
    <div id="config-bar"></div>
    <div id="app">
      <div class="loading-screen pixel-font">
        <div class="loading-flower">ğŸŒ»</div>
        <div class="loading-text">Loading...</div>
      </div>
    </div>
    <div id="donate-section"></div>
  </div>
  <div id="help-modal" class="modal-overlay" style="display:none"></div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONSTANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const DEFAULTS = { farm: "", key: "", limit: "5" };
    const DONATE_ADDR = "0x5688ee5f0488e1dc96d9aad5715e958914987cfc";
    const IMG_BASE = "https://sfl.world/img/flowers/";
    const PAGES = ["hub", "flowers", "dolls", "crustaceans"];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SEED DATA
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SEED_DATA = {
      "Sunpetal Seed":   { baseSeconds: 86400,  color: "#FFD700", label: "Sunpetal", season: null },
      "Bloom Seed":      { baseSeconds: 172800, color: "#FF69B4", label: "Bloom", season: null },
      "Edelweiss Seed":  { baseSeconds: 259200, color: "#87CEEB", label: "Edelweiss", season: "Winter" },
      "Gladiolus Seed":  { baseSeconds: 259200, color: "#FF6347", label: "Gladiolus", season: "Summer" },
      "Lavender Seed":   { baseSeconds: 259200, color: "#C8A2C8", label: "Lavender", season: "Spring" },
      "Clover Seed":     { baseSeconds: 259200, color: "#2ECC71", label: "Clover", season: "Autumn" },
      "Lily Seed":       { baseSeconds: 432000, color: "#B07CD8", label: "Lily", season: null },
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FLOWER BOOSTS (auto-detected from API)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const FLOWER_BOOSTS = [
      { name: "Flower Crown",      type: "wearable",        multiplier: 0.5  },
      { name: "Moth Shrine",       type: "collectible_temp", multiplier: 0.75, durationMs: 7 * 24 * 3600 * 1000 },
      { name: "Flower Fox",        type: "collectible",     multiplier: 0.9  },
      { name: "Blossom Hourglass", type: "collectible_temp", multiplier: 0.75, durationMs: 4 * 3600 * 1000 },
      { name: "Blooming Boost",    type: "skill",           multiplier: 0.9  },
      { name: "Flower Power",      type: "skill",           multiplier: 0.8  },
      { name: "Flowery Abode",     type: "skill",           multiplier: 1.5  },
    ];

    function findCollectible(farm, name) {
      // Collectibles can be on main island or home island
      const main = farm.collectibles?.[name] || [];
      const home = farm.home?.collectibles?.[name] || [];
      return [...main, ...home];
    }

    function detectFlowerBoosts(farm) {
      const active = [];
      for (const boost of FLOWER_BOOSTS) {
        let isActive = false;
        switch (boost.type) {
          case "wearable": {
            const equipped = farm.bumpkin?.equipped || {};
            isActive = Object.values(equipped).flat().includes(boost.name);
            break;
          }
          case "collectible": {
            isActive = findCollectible(farm, boost.name).length > 0;
            break;
          }
          case "collectible_temp": {
            const placements = findCollectible(farm, boost.name);
            if (placements.length > 0) {
              const latest = placements[placements.length - 1];
              const placedAt = toMs(latest.createdAt || latest.readyAt || 0);
              isActive = (Date.now() - placedAt) < boost.durationMs;
            }
            break;
          }
          case "skill": {
            const skills = farm.bumpkin?.skills || {};
            isActive = skills[boost.name] !== undefined;
            break;
          }
        }
        if (isActive) active.push(boost);
      }
      console.log("[Boosts]", active.map(b => `${b.name} Ã—${b.multiplier}`), "multiplier:", computeFlowerMultiplier(active));
      return active;
    }

    function computeFlowerMultiplier(activeBoosts) {
      return activeBoosts.reduce((m, b) => m * b.multiplier, 1);
    }

    function applyFlowerBoosts(multiplier) {
      for (const sd of Object.values(SEED_DATA)) {
        sd.seconds = sd.baseSeconds * multiplier;
        sd.hours = sd.seconds / 3600;
      }
    }

    // Initialize with no boosts (multiplier = 1)
    applyFlowerBoosts(1);

    const SEED_ORDER = [
      "Sunpetal Seed", "Bloom Seed",
      "Edelweiss Seed", "Gladiolus Seed", "Lavender Seed", "Clover Seed",
      "Lily Seed",
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FLOWER RECIPES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const FLOWER_RECIPES = {
      "Red Pansy":       { seed: "Sunpetal Seed", input: "Radish" },
      "Yellow Pansy":    { seed: "Sunpetal Seed", input: "Sunflower" },
      "Purple Cosmos":   { seed: "Sunpetal Seed", input: "Beetroot" },
      "Blue Cosmos":     { seed: "Sunpetal Seed", input: "Cauliflower" },
      "Blue Pansy":      { seed: "Sunpetal Seed", input: "Purple Cosmos" },
      "Yellow Cosmos":   { seed: "Sunpetal Seed", input: "Yellow Pansy" },
      "Purple Pansy":    { seed: "Sunpetal Seed", input: "Blue Pansy" },
      "White Pansy":     { seed: "Sunpetal Seed", input: "Yellow Cosmos" },
      "White Cosmos":    { seed: "Sunpetal Seed", input: "Prism Petal" },
      "Prism Petal":     { seed: "Sunpetal Seed", input: "Blue Lotus" },
      "Red Cosmos":      { seed: "Sunpetal Seed", input: "Yellow Daffodil" },

      "Red Balloon Flower":   { seed: "Bloom Seed", input: "Sunflower" },
      "Blue Balloon Flower":  { seed: "Bloom Seed", input: "Cauliflower" },
      "Purple Daffodil":      { seed: "Bloom Seed", input: "Radish" },
      "Red Daffodil":         { seed: "Bloom Seed", input: "Yellow Pansy" },
      "White Daffodil":       { seed: "Bloom Seed", input: "Yellow Cosmos" },
      "Celestial Frostbloom": { seed: "Bloom Seed", input: "White Pansy" },
      "White Balloon Flower": { seed: "Bloom Seed", input: "White Cosmos" },
      "Yellow Daffodil":      { seed: "Bloom Seed", input: "Red Cosmos" },
      "Blue Daffodil":        { seed: "Bloom Seed", input: "Purple Balloon Flower" },
      "Yellow Balloon Flower":{ seed: "Bloom Seed", input: "Yellow Lotus" },
      "Purple Balloon Flower":{ seed: "Bloom Seed", input: "Blue Carnation" },

      "Purple Carnation": { seed: "Lily Seed", input: "Eggplant" },
      "Red Lotus":        { seed: "Lily Seed", input: "Beetroot" },
      "White Lotus":      { seed: "Lily Seed", input: "Cauliflower" },
      "Yellow Carnation": { seed: "Lily Seed", input: "Sunflower" },
      "White Carnation":  { seed: "Lily Seed", input: "Yellow Pansy" },
      "Yellow Lotus":     { seed: "Lily Seed", input: "Red Pansy" },
      "Blue Lotus":       { seed: "Lily Seed", input: "Blue Pansy" },
      "Blue Carnation":   { seed: "Lily Seed", input: "Purple Daffodil" },
      "Red Carnation":    { seed: "Lily Seed", input: "Purple Pansy" },
      "Purple Lotus":     { seed: "Lily Seed", input: "Blue Carnation" },
      "Primula Enigma":   { seed: "Lily Seed", input: "Purple Balloon Flower" },

      "Red Edelweiss":    { seed: "Edelweiss Seed", input: "Artichoke" },
      "Yellow Edelweiss": { seed: "Edelweiss Seed", input: "Onion" },
      "Purple Edelweiss": { seed: "Edelweiss Seed", input: "Rhubarb" },
      "White Edelweiss":  { seed: "Edelweiss Seed", input: "Blue Edelweiss" },
      "Blue Edelweiss":   { seed: "Edelweiss Seed", input: "Purple Edelweiss" },

      "Red Gladiolus":    { seed: "Gladiolus Seed", input: "Yellow Edelweiss" },
      "Yellow Gladiolus": { seed: "Gladiolus Seed", input: "Pepper" },
      "Purple Gladiolus": { seed: "Gladiolus Seed", input: "Artichoke" },
      "White Gladiolus":  { seed: "Gladiolus Seed", input: "White Edelweiss" },
      "Blue Gladiolus":   { seed: "Gladiolus Seed", input: "Rhubarb" },

      "Red Lavender":     { seed: "Lavender Seed", input: "Pepper" },
      "Yellow Lavender":  { seed: "Lavender Seed", input: "Red Gladiolus" },
      "Purple Lavender":  { seed: "Lavender Seed", input: "Blue Lavender" },
      "White Lavender":   { seed: "Lavender Seed", input: "Rhubarb" },
      "Blue Lavender":    { seed: "Lavender Seed", input: "White Edelweiss" },

      "Red Clover":       { seed: "Clover Seed", input: "Red Edelweiss" },
      "Yellow Clover":    { seed: "Clover Seed", input: "Pepper" },
      "Purple Clover":    { seed: "Clover Seed", input: "Red Lavender" },
      "White Clover":     { seed: "Clover Seed", input: "Blue Edelweiss" },
      "Blue Clover":      { seed: "Clover Seed", input: "Rhubarb" },
    };

    const CROPS_AND_FRUITS = new Set([
      "Sunflower","Potato","Pumpkin","Carrot","Cabbage","Soybean",
      "Beetroot","Cauliflower","Parsnip","Eggplant","Corn","Radish",
      "Wheat","Kale","Turnip","Onion","Pepper","Rhubarb","Artichoke",
      "Barley","Zucchini","Yam","Broccoli",
      "Tomato","Lemon","Blueberry","Orange","Apple","Banana",
      "Grape","Rice","Olive",
      "Celestine","Lunara","Duskberry",
    ]);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DOLL RECIPES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const DOLL_RECIPES = {
      "Doll":           [{ item: "Leather", qty: 4 }, { item: "Wool", qty: 5 }],
      "Angler Doll":    [{ item: "Kelp Fibre", qty: 8 }, { item: "Doll", qty: 1 }],
      "Bloom Doll":     [{ item: "Doll", qty: 1 }, { item: "Prism Petal", qty: 3 }, { item: "Celestial Frostbloom", qty: 2 }, { item: "Primula Enigma", qty: 3 }],
      "Buzz Doll":      [{ item: "Honey", qty: 8 }, { item: "Doll", qty: 1 }],
      "Cluck Doll":     [{ item: "Feather", qty: 8 }, { item: "Doll", qty: 1 }],
      "Crude Doll":     [{ item: "Oil", qty: 8 }, { item: "Doll", qty: 1 }],
      "Ember Doll":     [{ item: "Crimsteel", qty: 8 }, { item: "Doll", qty: 1 }],
      "Gilded Doll":    [{ item: "Gold", qty: 8 }, { item: "Doll", qty: 1 }],
      "Harvest Doll":   [{ item: "Turnip", qty: 8 }, { item: "Doll", qty: 1 }],
      "Juicy Doll":     [{ item: "Tomato", qty: 8 }, { item: "Doll", qty: 1 }],
      "Lumber Doll":    [{ item: "Timber", qty: 8 }, { item: "Doll", qty: 1 }],
      "Lunar Doll":     [{ item: "Lunara", qty: 3 }, { item: "Duskberry", qty: 2 }, { item: "Doll", qty: 1 }, { item: "Celestine", qty: 3 }],
      "Moo Doll":       [{ item: "Leather", qty: 8 }, { item: "Doll", qty: 1 }],
      "Sizzle Doll":    [{ item: "Synthetic Fabric", qty: 8 }, { item: "Doll", qty: 1 }],
      "Wooly Doll":     [{ item: "Merino Wool", qty: 8 }, { item: "Doll", qty: 1 }],
      "Shadow Doll":    [{ item: "Obsidian", qty: 8 }, { item: "Doll", qty: 1 }],
      "Frosty Doll":    [{ item: "Celestial Frostbloom", qty: 8 }, { item: "Harvest Doll", qty: 1 }],
      "Grubby Doll":    [{ item: "Shadow Doll", qty: 1 }, { item: "Ember Doll", qty: 1 }, { item: "Gilded Doll", qty: 1 }],
      "Dune Doll":      [{ item: "Coral", qty: 8 }, { item: "Lumber Doll", qty: 1 }],
      "Solar Doll":     [],
      "Nefari Doll":    [],
      "Cosmo Doll":     [],
      "Bigfin Doll":    [],
    };

    const TRACKED_DOLLS_DEFAULT = {
      "Doll": true, "Angler Doll": true, "Bloom Doll": true, "Buzz Doll": true,
      "Cluck Doll": true, "Crude Doll": true, "Ember Doll": true, "Gilded Doll": true,
      "Harvest Doll": true, "Juicy Doll": true, "Lumber Doll": true, "Lunar Doll": true,
      "Moo Doll": true, "Sizzle Doll": true, "Wooly Doll": true,
      "Solar Doll": false, "Shadow Doll": false, "Nefari Doll": false, "Grubby Doll": false,
      "Frosty Doll": false, "Dune Doll": false, "Cosmo Doll": false, "Bigfin Doll": false,
    };

    function getTrackedDolls() {
      try {
        const saved = localStorage.getItem("sfl_tracked_dolls");
        if (saved) {
          const parsed = JSON.parse(saved);
          // Merge with defaults (in case new dolls were added)
          const result = { ...TRACKED_DOLLS_DEFAULT };
          for (const k of Object.keys(result)) {
            if (parsed[k] !== undefined) result[k] = parsed[k];
          }
          return result;
        }
      } catch (e) {}
      return { ...TRACKED_DOLLS_DEFAULT };
    }

    function saveTrackedDolls(tracked) {
      localStorage.setItem("sfl_tracked_dolls", JSON.stringify(tracked));
    }

    function toggleDollTracked(name) {
      const tracked = getTrackedDolls();
      tracked[name] = !tracked[name];
      saveTrackedDolls(tracked);
      // Re-render dolls page with cached data
      if (cachedFarmData) renderDolls(cachedFarmData);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CRUSTACEAN RECIPES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CRUSTACEAN_RECIPES = {
      "Blue Crab":    { pot: "Crab Pot", chum: "Heart Leaf", qty: 3, alt: "Ribbon x3", time: "4h" },
      "Lobster":      { pot: "Crab Pot", chum: "Wild Grass", qty: 3, alt: "Frost Pebble x3", time: "4h" },
      "Hermit Crab":  { pot: "Crab Pot", chum: "Grape", qty: 5, alt: "Rice x5", time: "4h" },
      "Shrimp":       { pot: "Crab Pot", chum: "Crimstone", qty: 2, alt: null, time: "4h" },
      "Mussel":       { pot: "Crab Pot", chum: "Moonfur", qty: 1, alt: null, time: "4h" },
      "Oyster":       { pot: "Crab Pot", chum: "Fish Stick", qty: 2, alt: null, time: "4h" },
      "Anemone":      { pot: "Crab Pot", chum: "Fish Oil", qty: 2, alt: "Crab Stick x2", time: "4h" },
      "Isopod":       { pot: "Crab Pot", chum: null, qty: 0, alt: null, time: "4h" },
      "Sea Slug":     { pot: "Mariner Pot", chum: "Crimstone", qty: 2, alt: null, time: "8h" },
      "Sea Snail":    { pot: "Mariner Pot", chum: "Chewed Bone", qty: 3, alt: "Ruffroot x3", time: "8h" },
      "Garden Eel":   { pot: "Mariner Pot", chum: "Dewberry", qty: 3, alt: "Duskberry x3", time: "8h" },
      "Sea Grapes":   { pot: "Mariner Pot", chum: "Lunara", qty: 3, alt: null, time: "8h" },
      "Octopus":      { pot: "Mariner Pot", chum: "Moonfur", qty: 1, alt: null, time: "8h" },
      "Sea Urchin":   { pot: "Mariner Pot", chum: "Fish Stick", qty: 2, alt: null, time: "8h" },
      "Horseshoe Crab":{ pot: "Mariner Pot", chum: "Crab Stick", qty: 2, alt: null, time: "8h" },
      "Barnacle":     { pot: "Mariner Pot", chum: null, qty: 0, alt: null, time: "8h" },
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  GLOBALS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let FARM_ID, API_KEY, LIMIT, FLOWER_BEDS, TRAP_COUNT;
    let lastInventory = null, lastInProgress = null;
    let cachedFarmData = null;
    let configExpanded = false;
    let growingTimerInterval = null;
    let pbTimerInterval = null;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ROUTER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getPage() {
      const p = new URLSearchParams(window.location.search);
      const page = p.get("page");
      if (page && PAGES.includes(page)) return page;
      const cfg = getConfig();
      return (cfg.farm && cfg.key) ? "flowers" : "hub";
    }

    function navigateTo(page) {
      const url = new URL(window.location);
      url.searchParams.set("page", page);
      history.pushState(null, "", url);
      configExpanded = false;
      main();
    }

    window.addEventListener("popstate", () => main());

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONFIG (localStorage + URL)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function migrateApiKey() {
      const p = new URLSearchParams(window.location.search);
      let changed = false;
      const keyFromUrl = p.get("key");
      if (keyFromUrl) {
        localStorage.setItem("sfl_api_key", keyFromUrl);
        p.delete("key");
        changed = true;
      }
      if (p.has("sunpetal")) {
        p.delete("sunpetal");
        changed = true;
      }
      if (changed) {
        const newUrl = window.location.pathname + (p.toString() ? "?" + p.toString() : "");
        history.replaceState(null, "", newUrl);
      }
    }

    function getConfig() {
      const p = new URLSearchParams(window.location.search);
      return {
        farm: p.get("farm") || DEFAULTS.farm,
        key: localStorage.getItem("sfl_api_key") || DEFAULTS.key,
        limit: parseInt(p.get("limit") || DEFAULTS.limit, 10) || 5,
      };
    }

    function saveConfig(farm, key, limit) {
      const p = new URLSearchParams(window.location.search);
      if (farm) p.set("farm", farm); else p.delete("farm");
      if (limit) p.set("limit", limit);
      // Clean up legacy sunpetal param
      p.delete("sunpetal");
      // Preserve page param
      const page = p.get("page");
      if (!page) p.set("page", getPage());
      // Key goes to localStorage only
      if (key) localStorage.setItem("sfl_api_key", key);
      const newURL = window.location.pathname + "?" + p.toString();
      history.replaceState(null, "", newURL);
    }

    function applyConfig() {
      const farm = document.getElementById("cfg-farm").value.trim();
      const key = document.getElementById("cfg-key").value.trim();
      const limit = document.getElementById("cfg-limit").value.trim();
      if (!farm || !key) return;
      saveConfig(farm, key, limit);
      cachedFarmData = null;
      configExpanded = false;
      main();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  NAV BAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderNavBar(page) {
      const links = [
        { id: "hub", label: "HUB" },
        { id: "flowers", label: "FLOWERS" },
        { id: "dolls", label: "DOLLS" },
        { id: "crustaceans", label: "CRABS" },
      ];
      let html = '<div class="nav-bar pixel-panel">';
      for (const l of links) {
        const cls = page === l.id ? " active" : "";
        html += `<button class="nav-link${cls}" onclick="navigateTo('${l.id}')">${l.label}</button>`;
      }
      html += '<button class="nav-link help-btn" onclick="openHelp()">?</button>';
      html += '</div>';
      document.getElementById("nav-bar").innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CONFIG BAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderConfigBar(page) {
      const cfg = getConfig();
      const el = document.getElementById("config-bar");
      const isHub = page === "hub";

      if (!isHub && !configExpanded && cfg.farm) {
        el.innerHTML = `<div class="config-collapsed pixel-panel pixel-font" onclick="expandConfig()">
          <span>Farm #${escHTML(cfg.farm)}</span>
          <span>Limit: ${cfg.limit}</span>
          <span class="config-toggle">EDIT &#9660;</span>
        </div>`;
        return;
      }

      el.innerHTML = `
        <div class="config-bar pixel-panel">
          <div class="config-field">
            <label class="pixel-font">FARM ID</label>
            <input id="cfg-farm" type="text" value="${escHTML(cfg.farm)}" placeholder="e.g. 155498">
          </div>
          <div class="config-field">
            <label class="pixel-font">API KEY</label>
            <input id="cfg-key" type="password" value="${escHTML(cfg.key)}" placeholder="sfl.xxxxx.xxxxx">
          </div>
          <div class="config-field small">
            <label class="pixel-font">LIMIT</label>
            <input id="cfg-limit" type="number" min="1" max="99" value="${cfg.limit}">
          </div>
          <button class="config-go" onclick="applyConfig()">LOAD</button>
        </div>`;

      const keyInput = document.getElementById("cfg-key");
      if (keyInput) {
        keyInput.addEventListener("focus", () => keyInput.type = "text");
        keyInput.addEventListener("blur", () => keyInput.type = "password");
      }
    }

    function expandConfig() {
      configExpanded = true;
      renderConfigBar(getPage());
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DONATE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderDonate() {
      const ethURI = `ethereum:${DONATE_ADDR}`;
      const qrURL = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(ethURI)}&bgcolor=ffffff&color=2c1810`;
      document.getElementById("donate-section").innerHTML = `
        <div class="donate-section pixel-panel pixel-font">
          <h3>SUPPORT THE PROJECT</h3>
          <p>If this tool helped you, consider sending<br>a flower or some ETH</p>
          <div class="donate-qr">
            <img src="${qrURL}" alt="Donate QR">
          </div>
          <br>
          <div class="donate-addr-wrap">
            <span class="donate-addr">${DONATE_ADDR}</span>
            <button class="donate-copy" onclick="copyAddr()">COPY</button>
          </div>
          <div class="donate-chain-label">ETH / Polygon / Base / Arbitrum</div>
          <div style="margin-top:16px;padding-top:12px;border-top:2px solid rgba(92,58,30,0.4);font-size:10px;color:var(--text-dim)">Created by 0xStableFarmer - #155498<br>Based on data from <a href="https://sfl.world" target="_blank" style="color:var(--sunpetal);text-decoration:none">sfl.world</a><br><span style="color:var(--text-dim);opacity:0.6">v1.4</span></div>
        </div>`;
    }

    function copyAddr() {
      navigator.clipboard.writeText(DONATE_ADDR).then(() => {
        const btn = document.querySelector(".donate-copy");
        btn.textContent = "COPIED!";
        setTimeout(() => btn.textContent = "COPY", 2000);
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HELP MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function openHelp() {
      const el = document.getElementById("help-modal");
      el.style.display = "flex";
      el.innerHTML = `<div class="modal-content pixel-panel pixel-font">
        <h2>HOW TO USE</h2>
        <h3>1. GET YOUR API KEY</h3>
        <p>In the game: <b>Settings &gt; General &gt; API Key</b></p>
        <h3>2. GET YOUR FARM ID</h3>
        <p>In the game: <b>Settings &gt; Farm ID</b></p>
        <h3>3. ENTER YOUR DETAILS</h3>
        <p><b>Farm ID</b> - your farm number (e.g. 155498)<br>
        <b>API Key</b> - starts with "sfl." (two dots)<br>
        <b>Limit</b> - target count per item (default: 5)</p>
        <h3>FLOWER BOOSTS</h3>
        <p>Flower grow time boosts are <b>auto-detected</b> from your farm data:<br>
        Flower Crown, Moth Shrine, Flower Fox,<br>
        Blossom Hourglass, Blooming Boost,<br>
        Flower Power, Flowery Abode</p>
        <h3>4. BOOKMARK THIS PAGE</h3>
        <p>Your Farm ID and settings are saved in the URL.<br>
        Your API key is stored locally in your browser (not in the URL).<br>
        Bookmark this page for quick access!</p>
        <h3>TRACKERS</h3>
        <p><b>FLOWERS</b> - All flower types with dependency chains and Petal Blessed planning<br>
        <b>DOLLS</b> - Doll crafting with ingredient requirements<br>
        <b>CRABS</b> - Crab/Mariner pot catches with chum needs</p>
        <h3>BUGS &amp; FEEDBACK</h3>
        <p><a href="https://github.com/hlavasim/sfl-flower-tracker/issues" target="_blank">github.com/hlavasim/sfl-flower-tracker/issues</a></p>
        <button class="modal-close" onclick="closeHelp()">CLOSE</button>
      </div>`;
    }

    function closeHelp() {
      document.getElementById("help-modal").style.display = "none";
    }

    document.addEventListener("click", (e) => {
      const modal = document.getElementById("help-modal");
      if (e.target === modal) closeHelp();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HELPERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getCount(inv, name) {
      const v = inv[name];
      if (v === undefined || v === null) return 0;
      return Math.floor(parseFloat(v));
    }

    function formatHours(h) {
      if (h <= 0) return "Done";
      const totalMin = Math.round(h * 60);
      const d = Math.floor(totalMin / 1440);
      const hrs = Math.floor((totalMin % 1440) / 60);
      const min = totalMin % 60;
      if (d > 0 && hrs > 0) return `${d}d ${hrs}h`;
      if (d > 0) return `${d}d`;
      if (hrs > 0 && min > 0) return `${hrs}h ${min}m`;
      if (hrs > 0) return `${hrs}h`;
      return `${min}m`;
    }

    function flowerColorCSS(name) {
      if (name.startsWith("Red")) return "#e74c3c";
      if (name.startsWith("Yellow")) return "#f1c40f";
      if (name.startsWith("Purple")) return "#9b59b6";
      if (name.startsWith("Blue")) return "#3498db";
      if (name.startsWith("White")) return "#ecf0f1";
      if (name === "Prism Petal") return "linear-gradient(135deg,#e74c3c,#f1c40f,#3498db,#9b59b6)";
      if (name === "Celestial Frostbloom") return "#a8d8ea";
      if (name === "Primula Enigma") return "#d5a6e6";
      return "#bdc3c7";
    }

    function barClass(pct) {
      if (pct >= 100) return "bar-green";
      if (pct >= 50) return "bar-yellow";
      return "bar-red";
    }

    function escHTML(s) {
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DEPENDENCY COMPUTATION (flowers)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function isFlowerInput(inputName) {
      return FLOWER_RECIPES[inputName] !== undefined;
    }

    function buildDependencyGraph() {
      const dependents = {};
      for (const [name, recipe] of Object.entries(FLOWER_RECIPES)) {
        if (isFlowerInput(recipe.input)) {
          if (!dependents[recipe.input]) dependents[recipe.input] = [];
          dependents[recipe.input].push(name);
        }
      }
      return dependents;
    }

    function computeAllTotalNeeded(inventory, inProgress) {
      const dependents = buildDependencyGraph();
      const memo = {};
      const visiting = new Set();

      function compute(name) {
        if (memo[name] !== undefined) return memo[name];
        if (visiting.has(name)) return LIMIT;
        visiting.add(name);
        let total = LIMIT;
        const deps = dependents[name] || [];
        for (const dep of deps) {
          const depNeeded = compute(dep);
          const depHave = getCount(inventory, dep) + (inProgress[dep] || 0);
          total += Math.max(0, depNeeded - depHave);
        }
        visiting.delete(name);
        memo[name] = total;
        return total;
      }

      const result = {};
      for (const name of Object.keys(FLOWER_RECIPES)) {
        result[name] = compute(name);
      }
      return { totalNeeded: result, dependents };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  API FETCH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function extractInProgress(farm) {
      const pending = {};
      const add = (name, qty) => { pending[name] = (pending[name] || 0) + qty; };

      // Flowers
      const beds = farm.flowers?.flowerBeds || {};
      for (const bed of Object.values(beds)) {
        if (bed.flower?.name) {
          const crits = bed.flower.criticalHit || {};
          const bonus = Object.values(crits).reduce((s, c) => s + c, 0);
          add(bed.flower.name, 1 + bonus);
        }
      }

      // Dolls: craftingBox
      const cb = farm.craftingBox;
      if (cb && cb.status === "crafting" && cb.item?.collectible) {
        add(cb.item.collectible, 1);
      }

      // Crustaceans: crabTraps
      const traps = farm.crabTraps?.trapSpots || {};
      for (const spot of Object.values(traps)) {
        const caught = spot.waterTrap?.caught || {};
        for (const [name, qty] of Object.entries(caught)) {
          add(name, qty);
        }
      }

      return pending;
    }

    function toMs(ts) {
      // SFL API timestamps may be in seconds or milliseconds
      return ts < 1e12 ? ts * 1000 : ts;
    }

    function extractBedDetails(flowerBeds) {
      const beds = [];
      for (const [id, bed] of Object.entries(flowerBeds)) {
        if (bed.flower?.name) {
          const name = bed.flower.name;
          const recipe = FLOWER_RECIPES[name];
          const seedType = recipe ? recipe.seed : "Unknown";
          const baseSeconds = recipe ? SEED_DATA[seedType].baseSeconds : 86400;
          const plantedAt = toMs(bed.flower.plantedAt);
          const crits = bed.flower.criticalHit || {};
          const bonus = Object.values(crits).reduce((s, c) => s + c, 0);
          const totalYield = 1 + bonus;
          const readyAt = plantedAt + baseSeconds * 1000;
          beds.push({ id, name, plantedAt, seedType, bonus, totalYield, readyAt });
        } else {
          beds.push({ id, name: null, empty: true });
        }
      }
      beds.sort((a, b) => {
        if (a.empty && !b.empty) return 1;
        if (!a.empty && b.empty) return -1;
        if (a.empty && b.empty) return 0;
        return a.readyAt - b.readyAt;
      });
      return beds;
    }

    const PETAL_BLESSED_COOLDOWN = 96 * 60 * 60;

    function extractPetalBlessed(farm) {
      const powers = farm.bumpkin?.previousPowerUseAt;
      if (!powers || powers["Petal Blessed"] === undefined) {
        return { status: "unavailable" };
      }
      const hasLunas = farm.wardrobe?.["Luna's Crescent"] > 0;
      const cooldownMs = PETAL_BLESSED_COOLDOWN * (hasLunas ? 0.5 : 1) * 1000;
      const lastUsed = toMs(powers["Petal Blessed"]);
      const nextAt = lastUsed + cooldownMs;
      if (Date.now() >= nextAt) {
        return { status: "ready" };
      }
      return { status: "cooldown", nextAt };
    }

    async function fetchFarmData() {
      if (!FARM_ID || !API_KEY) {
        throw new Error("Enter your Farm ID and API Key, then click LOAD");
      }

      const apiUrl = `https://api.sunflower-land.com/community/farms/${FARM_ID}`;
      const proxyUrl = `/api/proxy?url=${encodeURIComponent(apiUrl)}&key=${encodeURIComponent(API_KEY)}`;

      let data, lastErr;

      try {
        const resp = await fetch(proxyUrl);
        if (!resp.ok) throw new Error(`Proxy ${resp.status}`);
        data = await resp.json();
      } catch (proxyErr) {
        lastErr = proxyErr;
        console.warn("Proxy fetch failed, trying direct...", proxyErr);
        try {
          const resp = await fetch(apiUrl, { headers: { "x-api-key": API_KEY } });
          if (!resp.ok) throw new Error(`API ${resp.status}`);
          data = await resp.json();
          lastErr = null;
        } catch (directErr) {
          lastErr = directErr;
          console.warn("Direct fetch also failed:", directErr);
        }
      }

      if (!data) throw lastErr || new Error("All fetch attempts failed");

      const farm = data.farm || {};
      const inventory = farm.inventory || {};
      const flowerBeds = farm.flowers?.flowerBeds || {};
      const craftingBox = farm.craftingBox || null;
      const trapSpots = farm.crabTraps?.trapSpots || {};
      const inProgress = extractInProgress(farm);
      const petalBlessed = extractPetalBlessed(farm);
      const activeBoosts = detectFlowerBoosts(farm);
      const flowerMultiplier = computeFlowerMultiplier(activeBoosts);
      return { inventory, inProgress, petalBlessed, flowerBeds, craftingBox, trapSpots, activeBoosts, flowerMultiplier };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TIMERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function startGrowingTimers() {
      if (growingTimerInterval) clearInterval(growingTimerInterval);
      growingTimerInterval = setInterval(() => {
        const els = document.querySelectorAll(".growing-bed-time[data-ready]");
        if (els.length === 0) { clearInterval(growingTimerInterval); return; }
        const now = Date.now();
        els.forEach(el => {
          const readyAt = parseInt(el.dataset.ready, 10);
          const diff = readyAt - now;
          if (diff <= 0) {
            el.textContent = "Ready!";
            el.classList.remove("growing");
            el.classList.add("ready");
          } else {
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            el.textContent = h > 0
              ? `${h}h ${String(m).padStart(2,"0")}m`
              : `${m}m ${String(s).padStart(2,"0")}s`;
          }
        });
      }, 1000);
    }

    function startPBTimer() {
      if (pbTimerInterval) clearInterval(pbTimerInterval);
      const el = document.getElementById("pb-timer");
      if (!el) return;
      const nextAt = parseInt(el.dataset.next, 10);

      function tick() {
        const el = document.getElementById("pb-timer");
        if (!el) { clearInterval(pbTimerInterval); return; }
        const diff = nextAt - Date.now();
        if (diff <= 0) {
          clearInterval(pbTimerInterval);
          refresh();
          return;
        }
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        el.textContent = `${h}h ${String(m).padStart(2,"0")}m ${String(s).padStart(2,"0")}s`;
      }

      tick();
      pbTimerInterval = setInterval(tick, 1000);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CHAIN DETAILS (clickable expand)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function buildChainHTML(name, inventory, inProgress, visited) {
      if (!visited) visited = new Set();
      if (visited.has(name)) return `<div class="chain-step"><span class="chain-flower">${escHTML(name)}</span> (circular ref)</div>`;
      visited.add(name);

      const recipe = FLOWER_RECIPES[name];
      if (!recipe) return "";

      const sd = SEED_DATA[recipe.seed];
      const have = getCount(inventory, name) + (inProgress[name] || 0);
      const haveClass = have > 0 ? "chain-have" : "chain-need";

      let html = `<div class="chain-step">`;
      html += `<span class="${haveClass}">${escHTML(name)}</span>`;
      html += ` <span style="color:var(--text-dim)">(have: ${have})</span>`;
      html += ` = <span class="chain-seed">${sd.label} Seed</span>`;

      if (isFlowerInput(recipe.input)) {
        html += ` + <span class="chain-flower">${escHTML(recipe.input)}</span>`;
        html += buildChainHTML(recipe.input, inventory, inProgress, visited);
      } else {
        html += ` + <span class="chain-crop">${escHTML(recipe.input)}</span> <span style="color:var(--text-dim)">(crop)</span>`;
      }
      html += `</div>`;
      return html;
    }

    function toggleChain(el) {
      const row = el.closest(".flower-row");
      const existing = row.nextElementSibling;
      if (existing && existing.classList.contains("chain-detail")) {
        existing.remove();
        return;
      }
      document.querySelectorAll(".chain-detail").forEach(d => d.remove());

      const name = row.dataset.flower;
      if (!name || !lastInventory) return;

      const recipe = FLOWER_RECIPES[name];
      if (!recipe) return;

      const sd = SEED_DATA[recipe.seed];
      let html = `<strong>Recipe:</strong> <span class="chain-seed">${sd.label} Seed</span> + `;

      if (isFlowerInput(recipe.input)) {
        html += `<span class="chain-flower">${escHTML(recipe.input)}</span>`;
        html += buildChainHTML(recipe.input, lastInventory, lastInProgress || {});
      } else {
        html += `<span class="chain-crop">${escHTML(recipe.input)}</span> <span style="color:var(--text-dim)">(crop)</span>`;
      }

      const detail = document.createElement("div");
      detail.className = "chain-detail";
      detail.innerHTML = html;
      row.after(detail);
    }

    function toggleDollChain(el) {
      const row = el.closest(".flower-row");
      const existing = row.nextElementSibling;
      if (existing && existing.classList.contains("chain-detail")) {
        existing.remove();
        return;
      }
      document.querySelectorAll(".chain-detail").forEach(d => d.remove());

      const name = row.dataset.doll;
      if (!name || !lastInventory) return;

      const ingredients = DOLL_RECIPES[name];
      if (!ingredients || ingredients.length === 0) {
        const detail = document.createElement("div");
        detail.className = "chain-detail";
        detail.innerHTML = `<span style="color:var(--text-dim)">Recipe unknown</span>`;
        row.after(detail);
        return;
      }

      let html = `<strong>Ingredients per craft:</strong>`;
      for (const ing of ingredients) {
        const have = getCount(lastInventory, ing.item);
        const ok = have >= ing.qty;
        html += `<div class="chain-step">
          <span class="${ok ? "chain-have" : "chain-need"}">${escHTML(ing.item)}</span>
          x${ing.qty} <span style="color:var(--text-dim)">(have: ${have})</span>
          ${ok ? '<span style="color:var(--green)">OK</span>' : `<span style="color:var(--red)">need ${Math.max(0, ing.qty - have)} more</span>`}
        </div>`;
      }

      const detail = document.createElement("div");
      detail.className = "chain-detail";
      detail.innerHTML = html;
      row.after(detail);
    }

    function toggleCrustChain(el) {
      const row = el.closest(".flower-row");
      const existing = row.nextElementSibling;
      if (existing && existing.classList.contains("chain-detail")) {
        existing.remove();
        return;
      }
      document.querySelectorAll(".chain-detail").forEach(d => d.remove());

      const name = row.dataset.crust;
      if (!name || !lastInventory) return;

      const recipe = CRUSTACEAN_RECIPES[name];
      if (!recipe) return;

      let html = `<strong>Pot:</strong> ${escHTML(recipe.pot)} (${recipe.time})`;

      if (recipe.chum) {
        const chumHave = getCount(lastInventory, recipe.chum);
        const ok = chumHave >= recipe.qty;
        html += `<div class="chain-step">
          <strong>Chum:</strong> <span class="${ok ? "chain-have" : "chain-need"}">${escHTML(recipe.chum)}</span>
          x${recipe.qty} <span style="color:var(--text-dim)">(have: ${chumHave})</span>
          ${ok ? '<span style="color:var(--green)">OK</span>' : `<span style="color:var(--red)">need ${Math.max(0, recipe.qty - chumHave)} more</span>`}
        </div>`;
      } else {
        html += `<div class="chain-step"><span style="color:var(--text-dim)">No chum required</span></div>`;
      }

      if (recipe.alt) {
        html += `<div class="chain-step"><strong>Alt chum:</strong> <span style="color:var(--text-secondary)">${escHTML(recipe.alt)}</span></div>`;
      }

      const detail = document.createElement("div");
      detail.className = "chain-detail";
      detail.innerHTML = html;
      row.after(detail);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PETAL BLESSED
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getPetalBlessedRecommendation(inventory, inProgress) {
      const { totalNeeded } = computeAllTotalNeeded(inventory, inProgress);
      const candidates = [];
      for (const [name, needed] of Object.entries(totalNeeded)) {
        const have = getCount(inventory, name);
        const pend = inProgress[name] || 0;
        const remaining = Math.max(0, needed - have - pend);
        if (remaining <= 0) continue;
        const recipe = FLOWER_RECIPES[name];
        const seedHours = SEED_DATA[recipe.seed].hours;
        const inputIsFlower = isFlowerInput(recipe.input);
        let inputReady = true;
        if (inputIsFlower) {
          const inputHave = getCount(inventory, recipe.input) + (inProgress[recipe.input] || 0);
          if (inputHave <= 0) inputReady = false;
        }
        candidates.push({ name, remaining, seedHours, seed: recipe.seed, input: recipe.input, inputIsFlower, inputReady });
      }
      candidates.sort((a, b) => {
        if (b.seedHours !== a.seedHours) return b.seedHours - a.seedHours;
        if (a.inputReady !== b.inputReady) return a.inputReady ? -1 : 1;
        return b.remaining - a.remaining;
      });
      const picks = [];
      const used = {};
      for (const c of candidates) {
        if (picks.length >= FLOWER_BEDS) break;
        const canUse = Math.min(c.remaining - (used[c.name] || 0), FLOWER_BEDS - picks.length);
        for (let i = 0; i < canUse; i++) {
          picks.push(c);
          used[c.name] = (used[c.name] || 0) + 1;
        }
      }
      return picks;
    }

    function togglePetalBlessed() {
      const container = document.getElementById("petal-blessed-container");
      if (container.innerHTML) {
        container.innerHTML = "";
        return;
      }
      if (!lastInventory) return;

      const picks = getPetalBlessedRecommendation(lastInventory, lastInProgress);
      if (picks.length === 0) {
        container.innerHTML = `<div class="petal-blessed-panel pixel-font">
          <h3>PETAL BLESSED</h3>
          <p class="pb-subtitle">All flowers are complete! Nothing to grow.</p>
        </div>`;
        return;
      }

      const totalSaved = picks.reduce((s, p) => s + p.seedHours, 0);
      let bedsHTML = "";
      picks.forEach((p, i) => {
        const sd = SEED_DATA[p.seed];
        const inputLabel = p.inputIsFlower
          ? `${sd.label} Seed + <span style="color:var(--yellow)">${escHTML(p.input)}</span>${p.inputReady ? "" : " <span style='color:var(--red)'>(!)</span>"}`
          : `${sd.label} Seed + ${escHTML(p.input)}`;
        bedsHTML += `<div class="pb-bed">
          <div class="pb-bed-num">${i + 1}</div>
          <img class="pb-bed-img" src="${IMG_BASE}${encodeURIComponent(p.name)}.png" onerror="this.style.display='none'" alt="">
          <div class="pb-bed-info">
            <div class="pb-bed-name">${escHTML(p.name)}</div>
            <div class="pb-bed-recipe">${inputLabel}</div>
          </div>
          <div class="pb-bed-time">${formatHours(p.seedHours)}<div class="saved">saved</div></div>
        </div>`;
      });

      container.innerHTML = `<div class="petal-blessed-panel pixel-font">
        <h3>PETAL BLESSED</h3>
        <div class="pb-subtitle">Plant these ${picks.length} flowers, then use instant grow â€” saves ${formatHours(totalSaved)}</div>
        ${bedsHTML}
        <button class="pb-close" onclick="togglePetalBlessed()">CLOSE</button>
      </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RENDER: HUB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderHub(data) {
      const app = document.getElementById("app");
      const flowerTotal = Object.keys(FLOWER_RECIPES).length;
      const trackedDolls = getTrackedDolls();
      const dollTotal = Object.entries(trackedDolls).filter(([,v]) => v).length;
      const crustTotal = Object.keys(CRUSTACEAN_RECIPES).length;

      let flowerProgress = "", dollProgress = "", crustProgress = "";

      if (data) {
        const { inventory, inProgress } = data;
        const { totalNeeded } = computeAllTotalNeeded(inventory, inProgress);

        let fc = 0;
        for (const [name, needed] of Object.entries(totalNeeded)) {
          if (getCount(inventory, name) + (inProgress[name] || 0) >= needed) fc++;
        }
        flowerProgress = `<div class="hub-card-progress pixel-font">${fc}/${flowerTotal} complete</div>`;

        let dc = 0;
        for (const [name, tracked] of Object.entries(trackedDolls)) {
          if (!tracked) continue;
          if (getCount(inventory, name) + (inProgress[name] || 0) >= LIMIT) dc++;
        }
        dollProgress = `<div class="hub-card-progress pixel-font">${dc}/${dollTotal} complete</div>`;

        let cc = 0;
        for (const name of Object.keys(CRUSTACEAN_RECIPES)) {
          if (getCount(inventory, name) + (inProgress[name] || 0) >= LIMIT) cc++;
        }
        crustProgress = `<div class="hub-card-progress pixel-font">${cc}/${crustTotal} complete</div>`;
      }

      let html = `<div class="header pixel-panel pixel-font">
        <h1>SFL COLLECTION TRACKER</h1>
        ${FARM_ID ? `<div class="farm-id">Farm #${escHTML(FARM_ID)} | Target: ${LIMIT} of each</div>` : `<div class="farm-id">Enter your Farm ID &amp; API Key to get started</div>`}
      </div>`;

      html += `<div class="hub-cards">
        <div class="hub-card pixel-panel" onclick="navigateTo('flowers')">
          <div class="hub-card-icon">ğŸŒ¸</div>
          <h3 class="pixel-font">FLOWERS</h3>
          <div class="hub-card-count pixel-font">${flowerTotal} types</div>
          ${flowerProgress}
        </div>
        <div class="hub-card pixel-panel" onclick="navigateTo('dolls')">
          <div class="hub-card-icon">ğŸª†</div>
          <h3 class="pixel-font">DOLLS</h3>
          <div class="hub-card-count pixel-font">${dollTotal} tracked</div>
          ${dollProgress}
        </div>
        <div class="hub-card pixel-panel" onclick="navigateTo('crustaceans')">
          <div class="hub-card-icon">ğŸ¦€</div>
          <h3 class="pixel-font">CRUSTACEANS</h3>
          <div class="hub-card-count pixel-font">${crustTotal} types</div>
          ${crustProgress}
        </div>
      </div>`;

      app.innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RENDER: FLOWERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderFlowers(data) {
      const { inventory, inProgress, petalBlessed, flowerBeds, activeBoosts, flowerMultiplier } = data;
      lastInventory = inventory;
      lastInProgress = inProgress;

      const { totalNeeded, dependents } = computeAllTotalNeeded(inventory, inProgress);
      const app = document.getElementById("app");

      const groups = {};
      for (const seed of SEED_ORDER) groups[seed] = [];
      for (const [name, recipe] of Object.entries(FLOWER_RECIPES)) {
        groups[recipe.seed].push(name);
      }

      const flowerData = {};
      let totalComplete = 0, totalAll = 0, grandRemaining = 0;

      for (const [name, needed] of Object.entries(totalNeeded)) {
        const have = getCount(inventory, name);
        const pend = inProgress[name] || 0;
        const remaining = Math.max(0, needed - have - pend);
        const isComplete = remaining === 0;
        if (isComplete) totalComplete++;
        totalAll++;
        grandRemaining += remaining;
        const recipe = FLOWER_RECIPES[name];
        flowerData[name] = {
          name, needed, have, pend, remaining, isComplete,
          seed: recipe.seed, input: recipe.input,
          inputIsFlower: isFlowerInput(recipe.input),
          consumedBy: dependents[name] || [],
          ownNeed: LIMIT, depNeed: needed - LIMIT,
        };
      }

      const seedStats = {};
      for (const seed of SEED_ORDER) {
        const flowers = groups[seed];
        let rem = 0, complete = 0;
        for (const f of flowers) {
          rem += flowerData[f].remaining;
          if (flowerData[f].isComplete) complete++;
        }
        const batches = Math.ceil(rem / FLOWER_BEDS);
        const hours = batches * SEED_DATA[seed].hours;
        seedStats[seed] = { remaining: rem, complete, total: flowers.length, batches, hours };
      }

      const grandHours = Object.values(seedStats).reduce((s, x) => s + x.hours, 0);
      const pctComplete = totalAll > 0 ? Math.round((totalComplete / totalAll) * 100) : 0;

      let html = "";

      html += `<div class="header pixel-panel pixel-font">
        <h1>FLOWER TRACKER</h1>
        <div class="farm-id">Farm #${escHTML(FARM_ID)} | Target: ${LIMIT} of each</div>
      </div>`;

      html += `<div class="summary-bar pixel-panel pixel-font">
        <div class="summary-stat"><div class="label">COMPLETE</div><div class="value complete">${totalComplete} / ${totalAll}</div></div>
        <div class="summary-stat"><div class="label">REMAINING</div><div class="value pending">${grandRemaining} grows</div></div>
        <div class="summary-stat"><div class="label">BEDS</div><div class="value" style="color:var(--sunpetal)">${FLOWER_BEDS}</div></div>
        <div class="summary-stat"><div class="label">EST. TIME</div><div class="value time">${formatHours(grandHours)}</div></div>
      </div>`;

      if (activeBoosts && activeBoosts.length > 0) {
        const pctStr = Math.round(Math.abs(1 - flowerMultiplier) * 100);
        const sign = flowerMultiplier <= 1 ? "-" : "+";
        const color = flowerMultiplier <= 1 ? "var(--green)" : "var(--red)";
        html += `<div class="boost-bar pixel-panel pixel-font" style="padding:8px 12px;display:flex;flex-wrap:wrap;align-items:center;gap:6px 12px;font-size:9px">
          <span style="color:${color}">BOOSTS ${sign}${pctStr}%</span>
          ${activeBoosts.map(b => `<span style="color:var(--text-secondary)">${escHTML(b.name)} <span style="color:var(--text-dim)">&times;${b.multiplier}</span></span>`).join("")}
          <span style="color:var(--text-dim);margin-left:auto">Sunpetal: ${formatHours(SEED_DATA["Sunpetal Seed"].hours)}</span>
        </div>`;
      }

      html += `<div class="progress-overview pixel-panel">
        <div class="progress-label pixel-font"><span>Progress</span><span>${pctComplete}%</span></div>
        <div class="progress-bar-outer"><div class="progress-bar-fill green" style="width:${pctComplete}%"></div></div>
      </div>`;

      // Currently Growing
      if (flowerBeds) {
        const beds = extractBedDetails(flowerBeds);
        if (beds.length > 0) {
          html += `<div class="growing-section pixel-panel pixel-font">
            <div class="growing-title">CURRENTLY GROWING</div>
            <div class="growing-grid">`;
          const now = Date.now();
          for (const bed of beds) {
            if (bed.empty) {
              html += `<div class="growing-bed empty-bed">
                <div style="width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:18px;opacity:0.3">ğŸŒ±</div>
                <div class="growing-bed-info"><div class="growing-bed-name" style="color:var(--text-dim)">Empty</div></div>
              </div>`;
            } else {
              const diff = bed.readyAt - now;
              const isReady = diff <= 0;
              let timeStr;
              if (isReady) { timeStr = "Ready!"; }
              else { const h = Math.floor(diff/3600000); const m = Math.floor((diff%3600000)/60000); timeStr = h > 0 ? `${h}h ${String(m).padStart(2,"0")}m` : `${m}m`; }
              const sdLabel = SEED_DATA[bed.seedType]?.label || "?";
              html += `<div class="growing-bed">
                <img class="growing-bed-img" src="${IMG_BASE}${encodeURIComponent(bed.name)}.png" onerror="this.style.display='none'" alt="">
                <div class="growing-bed-info">
                  <div class="growing-bed-name">${escHTML(bed.name)}</div>
                  <div class="growing-bed-detail">${sdLabel} | yield: ${bed.totalYield}${bed.bonus > 0 ? ` (1+${bed.bonus})` : ""}</div>
                </div>
                <div class="growing-bed-time ${isReady ? "ready" : "growing"}" data-ready="${bed.readyAt}">${timeStr}</div>
              </div>`;
            }
          }
          html += `</div></div>`;
        }
      }

      // Petal Blessed
      if (petalBlessed.status === "ready") {
        html += `<button class="petal-blessed-btn" onclick="togglePetalBlessed()">Petal Blessed READY â€” tap to plan!</button>`;
      } else if (petalBlessed.status === "cooldown") {
        html += `<div class="petal-blessed-btn pb-cooldown" style="cursor:default;opacity:0.7;background:linear-gradient(180deg,#3b1768,#2a1050,#1e0a3c)">Petal Blessed in <span id="pb-timer" data-next="${petalBlessed.nextAt}">--:--:--</span></div>`;
      }
      html += `<div id="petal-blessed-container"></div>`;

      // Seed sections
      for (const seed of SEED_ORDER) {
        const sd = SEED_DATA[seed];
        const ss = seedStats[seed];
        const flowers = groups[seed];
        if (flowers.length === 0) continue;

        html += `<div class="seed-section">`;
        html += `<div class="seed-header pixel-font">
          <img class="seed-icon" src="${IMG_BASE}${encodeURIComponent(seed)}.webp" onerror="this.style.display='none'" alt="">
          <h2 style="color:${sd.color}">${sd.label}</h2>
          ${sd.season ? `<span class="seed-badge" style="border-color:${sd.color};color:${sd.color}">${sd.season}</span>` : ""}
          <div class="seed-meta">
            <span>${formatHours(sd.hours)} / grow</span>
            <span>${ss.complete}/${ss.total} done</span>
            <span>${ss.remaining > 0 ? `~${ss.batches} batches = ${formatHours(ss.hours)}` : "All complete!"}</span>
          </div>
        </div>`;

        html += `<div class="flower-grid">`;

        const sorted = [...flowers].sort((a, b) => {
          const fa = flowerData[a], fb = flowerData[b];
          if (fa.isComplete !== fb.isComplete) return fa.isComplete ? 1 : -1;
          return fb.remaining - fa.remaining;
        });

        for (const fname of sorted) {
          const f = flowerData[fname];
          const pct = f.needed > 0 ? Math.min(100, Math.round(((f.have + f.pend) / f.needed) * 100)) : 100;
          const color = flowerColorCSS(fname);
          const isGradient = color.includes("gradient");

          let chainHTML = "";
          if (f.inputIsFlower) {
            const inputData = flowerData[f.input];
            chainHTML += `<span class="input-flower">${escHTML(f.input)}</span>`;
            if (inputData) chainHTML += ` (${inputData.have + inputData.pend} avail)`;
          } else {
            chainHTML += `Direct`;
          }
          if (f.consumedBy.length > 0) {
            const tags = f.consumedBy.map(c => {
              const cd = flowerData[c];
              return `<span class="consumed-tag">${escHTML(c)} (x${cd ? cd.needed : "?"})</span>`;
            }).join("");
            chainHTML += ` <span class="consumed-by">used in</span>${tags}`;
          }

          html += `<div class="flower-row ${f.isComplete ? "complete" : ""}" data-flower="${escHTML(fname)}" onclick="toggleChain(this)">
            <div class="flower-img-wrap">
              <img class="flower-img" src="${IMG_BASE}${encodeURIComponent(fname)}.png" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'" alt="">
              <div class="flower-color-dot" style="display:none;${isGradient ? "background:" + color : "background-color:" + color}"></div>
            </div>
            <div class="flower-info">
              <div class="flower-name">${escHTML(fname)}</div>
              <div class="flower-chain">${chainHTML}</div>
            </div>
            <div class="flower-progress">
              <div class="flower-bar-outer"><div class="flower-bar-fill ${barClass(pct)}" style="width:${pct}%"></div></div>
              <div class="flower-count">
                <span class="have">${f.have}${f.pend > 0 ? `<span class="pending">+${f.pend}</span>` : ""} / ${f.needed}</span>
                ${f.depNeed > 0 ? `<span style="color:var(--text-dim);font-size:9px">(${f.ownNeed}+${f.depNeed})</span>` : ""}
              </div>
            </div>
            <div class="flower-time">
              ${f.isComplete
                ? `<div class="done pixel-font">DONE</div>`
                : `<div class="remaining-count pixel-font">-${f.remaining}</div><div class="remaining-time">${formatHours(f.remaining * sd.hours)}</div>`}
            </div>
          </div>`;
        }

        html += `</div></div>`;
      }

      html += `<div class="footer">
        <button class="refresh-btn" onclick="refresh()">REFRESH</button>
        <div class="timestamp pixel-font">Updated: ${new Date().toLocaleTimeString("cs-CZ")}</div>
      </div>`;

      app.innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RENDER: DOLLS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderDolls(data) {
      const { inventory, inProgress, craftingBox } = data;
      lastInventory = inventory;
      lastInProgress = inProgress;
      const app = document.getElementById("app");

      const trackedDolls = getTrackedDolls();
      const dollList = [];
      let totalComplete = 0, totalAll = 0, grandRemaining = 0;

      for (const [name, tracked] of Object.entries(trackedDolls)) {
        if (!tracked) continue;
        totalAll++;
        const have = getCount(inventory, name);
        const pend = inProgress[name] || 0;
        const remaining = Math.max(0, LIMIT - have - pend);
        const isComplete = remaining === 0;
        if (isComplete) totalComplete++;
        grandRemaining += remaining;
        dollList.push({ name, have, pend, remaining, isComplete, ingredients: DOLL_RECIPES[name] || [], needed: LIMIT });
      }

      const pctComplete = totalAll > 0 ? Math.round((totalComplete / totalAll) * 100) : 0;

      let html = `<div class="header pixel-panel pixel-font">
        <h1>DOLL TRACKER</h1>
        <div class="farm-id">Farm #${escHTML(FARM_ID)} | Target: ${LIMIT} of each</div>
      </div>`;

      // Tracked dolls toggle
      const allDollNames = Object.keys(DOLL_RECIPES);
      const trackedCount = Object.values(trackedDolls).filter(v => v).length;
      html += `<div class="config-collapsed pixel-panel pixel-font" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'" style="cursor:pointer">
        <span>Tracking ${trackedCount}/${allDollNames.length} dolls</span>
        <span class="config-toggle">CONFIGURE &#9660;</span>
      </div>
      <div style="display:none;margin-bottom:16px;padding:12px 16px;background:var(--bg-dark);border:4px solid var(--border-brown);box-shadow:0 0 0 3px #000">
        <div style="display:flex;flex-wrap:wrap;gap:6px">
          ${allDollNames.map(name => {
            const on = trackedDolls[name];
            return `<button onclick="event.stopPropagation();toggleDollTracked('${escHTML(name)}')" style="font-family:'Press Start 2P',cursive;font-size:8px;padding:6px 8px;border:2px solid ${on ? 'var(--green)' : 'var(--border-brown)'};background:${on ? 'rgba(48,209,88,0.15)' : 'var(--bg-card)'};color:${on ? 'var(--green)' : 'var(--text-dim)'};cursor:pointer;white-space:nowrap">${escHTML(name.replace(' Doll',''))}</button>`;
          }).join("")}
        </div>
      </div>`;

      html += `<div class="summary-bar pixel-panel pixel-font">
        <div class="summary-stat"><div class="label">COMPLETE</div><div class="value complete">${totalComplete} / ${totalAll}</div></div>
        <div class="summary-stat"><div class="label">REMAINING</div><div class="value pending">${grandRemaining} crafts</div></div>
      </div>`;

      html += `<div class="progress-overview pixel-panel">
        <div class="progress-label pixel-font"><span>Progress</span><span>${pctComplete}%</span></div>
        <div class="progress-bar-outer"><div class="progress-bar-fill green" style="width:${pctComplete}%"></div></div>
      </div>`;

      // Currently Crafting
      if (craftingBox && craftingBox.status === "crafting" && craftingBox.item?.collectible) {
        const readyAttr = craftingBox.readyAt ? ` data-ready="${craftingBox.readyAt}"` : "";
        html += `<div class="growing-section pixel-panel pixel-font">
          <div class="growing-title">CURRENTLY CRAFTING</div>
          <div class="growing-grid">
            <div class="growing-bed">
              <div style="font-size:24px;flex-shrink:0">ğŸª†</div>
              <div class="growing-bed-info">
                <div class="growing-bed-name">${escHTML(craftingBox.item.collectible)}</div>
                <div class="growing-bed-detail">Crafting Box</div>
              </div>
              <div class="growing-bed-time growing"${readyAttr}>Crafting...</div>
            </div>
          </div>
        </div>`;
      }

      // Doll list
      const sorted = dollList.sort((a, b) => {
        if (a.isComplete !== b.isComplete) return a.isComplete ? 1 : -1;
        return b.remaining - a.remaining;
      });

      html += `<div class="flower-grid" style="border:3px solid var(--border-dark)">`;
      for (const d of sorted) {
        const pct = d.needed > 0 ? Math.min(100, Math.round(((d.have + d.pend) / d.needed) * 100)) : 100;

        let ingredientHTML = "";
        if (d.ingredients.length === 0) {
          ingredientHTML = `<span style="color:var(--text-dim)">Recipe unknown</span>`;
        } else {
          ingredientHTML = d.ingredients.map(ing => {
            const have = getCount(inventory, ing.item);
            const ok = have >= ing.qty;
            return `<span style="color:${ok ? 'var(--green)' : 'var(--red)'}">${escHTML(ing.item)} x${ing.qty}</span>`;
          }).join(", ");
        }

        html += `<div class="flower-row ${d.isComplete ? 'complete' : ''}" data-doll="${escHTML(d.name)}" onclick="toggleDollChain(this)">
          <div class="flower-img-wrap" style="font-size:22px">ğŸª†</div>
          <div class="flower-info">
            <div class="flower-name">${escHTML(d.name)}</div>
            <div class="flower-chain">${ingredientHTML}</div>
          </div>
          <div class="flower-progress">
            <div class="flower-bar-outer"><div class="flower-bar-fill ${barClass(pct)}" style="width:${pct}%"></div></div>
            <div class="flower-count">
              <span class="have">${d.have}${d.pend > 0 ? `<span class="pending">+${d.pend}</span>` : ""} / ${d.needed}</span>
            </div>
          </div>
          <div class="flower-time">
            ${d.isComplete
              ? `<div class="done pixel-font">DONE</div>`
              : `<div class="remaining-count pixel-font">-${d.remaining}</div>`}
          </div>
        </div>`;
      }
      html += `</div>`;

      html += `<div class="footer">
        <button class="refresh-btn" onclick="refresh()">REFRESH</button>
        <div class="timestamp pixel-font">Updated: ${new Date().toLocaleTimeString("cs-CZ")}</div>
      </div>`;

      app.innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RENDER: CRUSTACEANS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderCrustaceans(data) {
      const { inventory, inProgress, trapSpots } = data;
      lastInventory = inventory;
      lastInProgress = inProgress;
      const app = document.getElementById("app");

      TRAP_COUNT = Math.max(1, Object.keys(trapSpots).length);

      let totalComplete = 0, totalAll = 0, grandRemaining = 0;
      const crustData = {};

      for (const [name, recipe] of Object.entries(CRUSTACEAN_RECIPES)) {
        totalAll++;
        const have = getCount(inventory, name);
        const pend = inProgress[name] || 0;
        const remaining = Math.max(0, LIMIT - have - pend);
        const isComplete = remaining === 0;
        if (isComplete) totalComplete++;
        grandRemaining += remaining;
        crustData[name] = { name, have, pend, remaining, isComplete, ...recipe, needed: LIMIT };
      }

      const pctComplete = totalAll > 0 ? Math.round((totalComplete / totalAll) * 100) : 0;

      let html = `<div class="header pixel-panel pixel-font">
        <h1>CRUSTACEAN TRACKER</h1>
        <div class="farm-id">Farm #${escHTML(FARM_ID)} | Target: ${LIMIT} of each</div>
      </div>`;

      html += `<div class="summary-bar pixel-panel pixel-font">
        <div class="summary-stat"><div class="label">COMPLETE</div><div class="value complete">${totalComplete} / ${totalAll}</div></div>
        <div class="summary-stat"><div class="label">REMAINING</div><div class="value pending">${grandRemaining} traps</div></div>
        <div class="summary-stat"><div class="label">TRAPS</div><div class="value" style="color:var(--sunpetal)">${TRAP_COUNT}</div></div>
      </div>`;

      html += `<div class="progress-overview pixel-panel">
        <div class="progress-label pixel-font"><span>Progress</span><span>${pctComplete}%</span></div>
        <div class="progress-bar-outer"><div class="progress-bar-fill green" style="width:${pctComplete}%"></div></div>
      </div>`;

      // Currently Trapping (caught, ready to collect)
      const caughtItems = [];
      for (const [id, spot] of Object.entries(trapSpots)) {
        const caught = spot.waterTrap?.caught || {};
        for (const [name, qty] of Object.entries(caught)) {
          caughtItems.push({ id, name, qty });
        }
      }

      if (caughtItems.length > 0) {
        html += `<div class="growing-section pixel-panel pixel-font">
          <div class="growing-title">READY TO COLLECT</div>
          <div class="growing-grid">`;
        for (const c of caughtItems) {
          html += `<div class="growing-bed">
            <div style="font-size:24px;flex-shrink:0">ğŸ¦€</div>
            <div class="growing-bed-info">
              <div class="growing-bed-name">${escHTML(c.name)}</div>
              <div class="growing-bed-detail">x${c.qty}</div>
            </div>
            <div class="growing-bed-time ready">Collect!</div>
          </div>`;
        }
        html += `</div></div>`;
      }

      // Pot sections
      const potGroups = {
        "Crab Pot": { label: "CRAB POT", time: "4h", emoji: "ğŸ¦€", items: [] },
        "Mariner Pot": { label: "MARINER POT", time: "8h", emoji: "ğŸŸ", items: [] },
      };

      for (const [name, d] of Object.entries(crustData)) {
        potGroups[d.pot].items.push(d);
      }

      for (const [potType, group] of Object.entries(potGroups)) {
        const sorted = [...group.items].sort((a, b) => {
          if (a.isComplete !== b.isComplete) return a.isComplete ? 1 : -1;
          return b.remaining - a.remaining;
        });

        const complete = sorted.filter(d => d.isComplete).length;

        html += `<div class="seed-section">
          <div class="seed-header pixel-font">
            <div style="font-size:22px">${group.emoji}</div>
            <h2 style="color:var(--blue)">${group.label}</h2>
            <div class="seed-meta">
              <span>${group.time} / trap</span>
              <span>${complete}/${sorted.length} done</span>
            </div>
          </div>
          <div class="flower-grid">`;

        for (const d of sorted) {
          const pct = d.needed > 0 ? Math.min(100, Math.round(((d.have + d.pend) / d.needed) * 100)) : 100;

          let chumHTML = "";
          if (d.chum) {
            const chumHave = getCount(inventory, d.chum);
            const ok = chumHave >= d.qty;
            chumHTML = `<span style="color:${ok ? 'var(--green)' : 'var(--yellow)'}">${escHTML(d.chum)} x${d.qty}</span>`;
            if (d.alt) chumHTML += ` <span style="color:var(--text-dim);font-size:10px">alt: ${escHTML(d.alt)}</span>`;
          } else {
            chumHTML = `<span style="color:var(--text-dim)">No chum needed</span>`;
          }

          html += `<div class="flower-row ${d.isComplete ? 'complete' : ''}" data-crust="${escHTML(d.name)}" onclick="toggleCrustChain(this)">
            <div class="flower-img-wrap" style="font-size:18px">${group.emoji}</div>
            <div class="flower-info">
              <div class="flower-name">${escHTML(d.name)}</div>
              <div class="flower-chain">${chumHTML}</div>
            </div>
            <div class="flower-progress">
              <div class="flower-bar-outer"><div class="flower-bar-fill ${barClass(pct)}" style="width:${pct}%"></div></div>
              <div class="flower-count">
                <span class="have">${d.have}${d.pend > 0 ? `<span class="pending">+${d.pend}</span>` : ""} / ${d.needed}</span>
              </div>
            </div>
            <div class="flower-time">
              ${d.isComplete
                ? `<div class="done pixel-font">DONE</div>`
                : `<div class="remaining-count pixel-font">-${d.remaining}</div>`}
            </div>
          </div>`;
        }

        html += `</div></div>`;
      }

      html += `<div class="footer">
        <button class="refresh-btn" onclick="refresh()">REFRESH</button>
        <div class="timestamp pixel-font">Updated: ${new Date().toLocaleTimeString("cs-CZ")}</div>
      </div>`;

      app.innerHTML = html;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MAIN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function refresh() {
      cachedFarmData = null;
      main();
    }

    async function main() {
      const cfg = getConfig();
      const page = getPage();

      FARM_ID = cfg.farm;
      API_KEY = cfg.key;
      LIMIT = cfg.limit;
      FLOWER_BEDS = 4;

      renderNavBar(page);
      renderDonate();

      if (!FARM_ID || !API_KEY) {
        renderConfigBar("hub");
        renderHub(null);
        return;
      }

      renderConfigBar(page);

      const app = document.getElementById("app");

      if (!cachedFarmData) {
        app.innerHTML = `<div class="loading-screen pixel-font">
          <div class="loading-flower">ğŸŒ»</div>
          <div class="loading-text">Loading farm data...</div>
        </div>`;
      }

      try {
        if (!cachedFarmData) {
          cachedFarmData = await fetchFarmData();
        }
        const data = cachedFarmData;

        // Auto-detect bed/trap counts and apply boosts
        FLOWER_BEDS = Math.max(1, Object.keys(data.flowerBeds).length);
        applyFlowerBoosts(data.flowerMultiplier);

        switch (page) {
          case "hub": renderHub(data); break;
          case "flowers": renderFlowers(data); break;
          case "dolls": renderDolls(data); break;
          case "crustaceans": renderCrustaceans(data); break;
          default: renderHub(data);
        }

        if (page === "flowers") {
          startPBTimer();
          startGrowingTimers();
        }
        if (page === "dolls" && data.craftingBox?.readyAt) {
          startGrowingTimers();
        }
      } catch (err) {
        console.error(err);
        const needsConfig = !FARM_ID || !API_KEY;
        app.innerHTML = `<div class="error-screen pixel-panel pixel-font">
          <div class="icon">${needsConfig ? "ğŸ‘†" : "âš ï¸"}</div>
          <h2>${needsConfig ? "Enter your Farm ID & API Key above" : "Failed to load data"}</h2>
          <p>${escHTML(err.message)}</p>
          ${needsConfig ? `<p style="font-size:10px;color:var(--text-dim)">
            Get your API key at <a href="https://sfl.world" target="_blank" style="color:var(--sunpetal)">sfl.world</a><br>
            Your settings will be saved in the URL for bookmarking.
          </p>` : ""}
          <button class="refresh-btn" onclick="refresh()">RETRY</button>
        </div>`;
      }
    }

    // Enter key in config inputs triggers load
    document.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && e.target.closest(".config-bar")) applyConfig();
    });

    // Init
    migrateApiKey();
    main();
  </script>
</body>
</html>
